import { AsyncLocalStorage } from 'node:async_hooks';
export class AsyncLocalStorageStrategy {
    _storage = new AsyncLocalStorage();
    get(key) {
        const store = this._storage.getStore();
        this._throwErrorIfInactiveContext(store);
        return store.get(key);
    }
    set(key, value) {
        const store = this._storage.getStore();
        this._throwErrorIfInactiveContext(store);
        store.set(key, value);
    }
    clear(key) {
        const store = this._storage.getStore();
        this._throwErrorIfInactiveContext(store);
        store.delete(key);
    }
    createSession(callback, options) {
        const { defaultValue = {} } = options ?? {};
        const store = new Map(Object.entries(defaultValue));
        this._storage.run(store, callback);
    }
    _throwErrorIfInactiveContext(store) {
        if (!store) {
            throw new Error('No active session found');
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXN5bmMtbG9jYWwtc3RvcmFnZS1zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXNzaW9uLXN0cmF0ZWd5L2FzeW5jLWxvY2FsLXN0b3JhZ2Utc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFJcEQsTUFBTSxPQUFPLHlCQUF5QjtJQUNsQixRQUFRLEdBQUcsSUFBSSxpQkFBaUIsRUFBd0IsQ0FBQTtJQUUzRSxHQUFHLENBQUksR0FBVztRQUNqQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBQ3RDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUV4QyxPQUFPLEtBQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFrQixDQUFBO0lBQ3hDLENBQUM7SUFFRCxHQUFHLENBQUksR0FBVyxFQUFFLEtBQVE7UUFDM0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUN0QyxJQUFJLENBQUMsNEJBQTRCLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDeEMsS0FBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDdkIsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFXO1FBQ2hCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDdEMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3hDLEtBQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDbkIsQ0FBQztJQUVELGFBQWEsQ0FBQyxRQUFvQixFQUFFLE9BQThCO1FBQ2pFLE1BQU0sRUFBRSxZQUFZLEdBQUcsRUFBRSxFQUFFLEdBQUcsT0FBTyxJQUFJLEVBQUUsQ0FBQTtRQUMzQyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBa0IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFBO1FBQ3BFLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBRVMsNEJBQTRCLENBQUMsS0FBNEI7UUFDbEUsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO1FBQzNDLENBQUM7SUFDRixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3luY0xvY2FsU3RvcmFnZSB9IGZyb20gJ25vZGU6YXN5bmNfaG9va3MnXG5cbmltcG9ydCB7IHR5cGUgQ3JlYXRlU2Vzc2lvbk9wdGlvbnMsIHR5cGUgU2Vzc2lvblN0cmF0ZWd5IH0gZnJvbSAnI3NyYy9zZXNzaW9uLXN0cmF0ZWd5L3Nlc3Npb24tc3RyYXRlZ3knXG5cbmV4cG9ydCBjbGFzcyBBc3luY0xvY2FsU3RvcmFnZVN0cmF0ZWd5IGltcGxlbWVudHMgU2Vzc2lvblN0cmF0ZWd5IHtcblx0cHJvdGVjdGVkIHJlYWRvbmx5IF9zdG9yYWdlID0gbmV3IEFzeW5jTG9jYWxTdG9yYWdlPE1hcDxzdHJpbmcsIHVua25vd24+PigpXG5cblx0Z2V0PFQ+KGtleTogc3RyaW5nKTogVCB8IHVuZGVmaW5lZCB7XG5cdFx0Y29uc3Qgc3RvcmUgPSB0aGlzLl9zdG9yYWdlLmdldFN0b3JlKClcblx0XHR0aGlzLl90aHJvd0Vycm9ySWZJbmFjdGl2ZUNvbnRleHQoc3RvcmUpXG5cblx0XHRyZXR1cm4gc3RvcmUhLmdldChrZXkpIGFzIFQgfCB1bmRlZmluZWRcblx0fVxuXG5cdHNldDxUPihrZXk6IHN0cmluZywgdmFsdWU6IFQpOiB2b2lkIHtcblx0XHRjb25zdCBzdG9yZSA9IHRoaXMuX3N0b3JhZ2UuZ2V0U3RvcmUoKVxuXHRcdHRoaXMuX3Rocm93RXJyb3JJZkluYWN0aXZlQ29udGV4dChzdG9yZSlcblx0XHRzdG9yZSEuc2V0KGtleSwgdmFsdWUpXG5cdH1cblxuXHRjbGVhcihrZXk6IHN0cmluZyk6IHZvaWQge1xuXHRcdGNvbnN0IHN0b3JlID0gdGhpcy5fc3RvcmFnZS5nZXRTdG9yZSgpXG5cdFx0dGhpcy5fdGhyb3dFcnJvcklmSW5hY3RpdmVDb250ZXh0KHN0b3JlKVxuXHRcdHN0b3JlIS5kZWxldGUoa2V5KVxuXHR9XG5cblx0Y3JlYXRlU2Vzc2lvbihjYWxsYmFjazogKCkgPT4gdm9pZCwgb3B0aW9ucz86IENyZWF0ZVNlc3Npb25PcHRpb25zKTogdm9pZCB7XG5cdFx0Y29uc3QgeyBkZWZhdWx0VmFsdWUgPSB7fSB9ID0gb3B0aW9ucyA/PyB7fVxuXHRcdGNvbnN0IHN0b3JlID0gbmV3IE1hcDxzdHJpbmcsIHVua25vd24+KE9iamVjdC5lbnRyaWVzKGRlZmF1bHRWYWx1ZSkpXG5cdFx0dGhpcy5fc3RvcmFnZS5ydW4oc3RvcmUsIGNhbGxiYWNrKVxuXHR9XG5cblx0cHJvdGVjdGVkIF90aHJvd0Vycm9ySWZJbmFjdGl2ZUNvbnRleHQoc3RvcmU/OiBNYXA8c3RyaW5nLCB1bmtub3duPik6IHZvaWQge1xuXHRcdGlmICghc3RvcmUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignTm8gYWN0aXZlIHNlc3Npb24gZm91bmQnKVxuXHRcdH1cblx0fVxufVxuIl19